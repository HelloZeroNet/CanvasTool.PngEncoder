/**
 * @license
 * canvastool.pngencoder.js
 * JavaScript PNG Encoder
 * https://github.com/imaya/CanvasTool.PngEncoder
 *
 * The MIT License
 *
 * Copyright (c) 2011 imaya
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
(function() {var COMPILED=!0,goog=goog||{};goog.global=this;goog.DEBUG=!1;goog.LOCALE="en";goog.provide=function(a){if(!COMPILED){if(goog.isProvided_(a))throw Error('Namespace "'+a+'" already declared.');delete goog.implicitNamespaces_[a];for(var b=a;b=b.substring(0,b.lastIndexOf("."));){if(goog.getObjectByName(b))break;goog.implicitNamespaces_[b]=!0}}goog.exportPath_(a)};
goog.setTestOnly=function(a){if(COMPILED&&!goog.DEBUG)throw a=a||"",Error("Importing test-only code into non-debug environment"+a?": "+a:".");};if(!COMPILED)goog.isProvided_=function(a){return!goog.implicitNamespaces_[a]&&!!goog.getObjectByName(a)},goog.implicitNamespaces_={};goog.exportPath_=function(a,b,c){a=a.split(".");c=c||goog.global;!(a[0]in c)&&c.execScript&&c.execScript("var "+a[0]);for(var d;a.length&&(d=a.shift());)!a.length&&goog.isDef(b)?c[d]=b:c=c[d]?c[d]:c[d]={}};
goog.getObjectByName=function(a,b){for(var c=a.split("."),d=b||goog.global,e;e=c.shift();)if(goog.isDefAndNotNull(d[e]))d=d[e];else return null;return d};goog.globalize=function(a,b){var c=b||goog.global,d;for(d in a)c[d]=a[d]};
goog.addDependency=function(a,b,c){if(!COMPILED){for(var d,a=a.replace(/\\/g,"/"),e=goog.dependencies_,f=0;d=b[f];f++)e.nameToPath[d]=a,a in e.pathToNames||(e.pathToNames[a]={}),e.pathToNames[a][d]=!0;for(d=0;b=c[d];d++)a in e.requires||(e.requires[a]={}),e.requires[a][b]=!0}};goog.ENABLE_DEBUG_LOADER=!0;
goog.require=function(a){if(!COMPILED&&!goog.isProvided_(a)){if(goog.ENABLE_DEBUG_LOADER){var b=goog.getPathFromDeps_(a);if(b){goog.included_[b]=!0;goog.writeScripts_();return}}a="goog.require could not find: "+a;goog.global.console&&goog.global.console.error(a);throw Error(a);}};goog.basePath="";goog.nullFunction=function(){};goog.identityFunction=function(a){return a};goog.abstractMethod=function(){throw Error("unimplemented abstract method");};
goog.addSingletonGetter=function(a){a.getInstance=function(){return a.instance_||(a.instance_=new a)}};
if(!COMPILED&&goog.ENABLE_DEBUG_LOADER)goog.included_={},goog.dependencies_={pathToNames:{},nameToPath:{},requires:{},visited:{},written:{}},goog.inHtmlDocument_=function(){var a=goog.global.document;return typeof a!="undefined"&&"write"in a},goog.findBasePath_=function(){if(goog.global.CLOSURE_BASE_PATH)goog.basePath=goog.global.CLOSURE_BASE_PATH;else if(goog.inHtmlDocument_())for(var a=goog.global.document.getElementsByTagName("script"),b=a.length-1;b>=0;--b){var c=a[b].src,d=c.lastIndexOf("?"),
d=d==-1?c.length:d;if(c.substr(d-7,7)=="base.js"){goog.basePath=c.substr(0,d-7);break}}},goog.importScript_=function(a){var b=goog.global.CLOSURE_IMPORT_SCRIPT||goog.writeScriptTag_;!goog.dependencies_.written[a]&&b(a)&&(goog.dependencies_.written[a]=!0)},goog.writeScriptTag_=function(a){return goog.inHtmlDocument_()?(goog.global.document.write('<script type="text/javascript" src="'+a+'"><\/script>'),!0):!1},goog.writeScripts_=function(){function a(e){if(!(e in d.written)){if(!(e in d.visited)&&(d.visited[e]=
!0,e in d.requires))for(var g in d.requires[e])if(!goog.isProvided_(g))if(g in d.nameToPath)a(d.nameToPath[g]);else throw Error("Undefined nameToPath for "+g);e in c||(c[e]=!0,b.push(e))}}var b=[],c={},d=goog.dependencies_,e;for(e in goog.included_)d.written[e]||a(e);for(e=0;e<b.length;e++)if(b[e])goog.importScript_(goog.basePath+b[e]);else throw Error("Undefined script input");},goog.getPathFromDeps_=function(a){return a in goog.dependencies_.nameToPath?goog.dependencies_.nameToPath[a]:null},goog.findBasePath_(),
goog.global.CLOSURE_NO_DEPS||goog.importScript_(goog.basePath+"deps.js");
goog.typeOf=function(a){var b=typeof a;if(b=="object")if(a){if(a instanceof Array)return"array";else if(a instanceof Object)return b;var c=Object.prototype.toString.call(a);if(c=="[object Window]")return"object";if(c=="[object Array]"||typeof a.length=="number"&&typeof a.splice!="undefined"&&typeof a.propertyIsEnumerable!="undefined"&&!a.propertyIsEnumerable("splice"))return"array";if(c=="[object Function]"||typeof a.call!="undefined"&&typeof a.propertyIsEnumerable!="undefined"&&!a.propertyIsEnumerable("call"))return"function"}else return"null";
else if(b=="function"&&typeof a.call=="undefined")return"object";return b};goog.propertyIsEnumerableCustom_=function(a,b){if(b in a)for(var c in a)if(c==b&&Object.prototype.hasOwnProperty.call(a,b))return!0;return!1};goog.propertyIsEnumerable_=function(a,b){return a instanceof Object?Object.prototype.propertyIsEnumerable.call(a,b):goog.propertyIsEnumerableCustom_(a,b)};goog.isDef=function(a){return a!==void 0};goog.isNull=function(a){return a===null};goog.isDefAndNotNull=function(a){return a!=null};
goog.isArray=function(a){return goog.typeOf(a)=="array"};goog.isArrayLike=function(a){var b=goog.typeOf(a);return b=="array"||b=="object"&&typeof a.length=="number"};goog.isDateLike=function(a){return goog.isObject(a)&&typeof a.getFullYear=="function"};goog.isString=function(a){return typeof a=="string"};goog.isBoolean=function(a){return typeof a=="boolean"};goog.isNumber=function(a){return typeof a=="number"};goog.isFunction=function(a){return goog.typeOf(a)=="function"};
goog.isObject=function(a){a=goog.typeOf(a);return a=="object"||a=="array"||a=="function"};goog.getUid=function(a){return a[goog.UID_PROPERTY_]||(a[goog.UID_PROPERTY_]=++goog.uidCounter_)};goog.removeUid=function(a){"removeAttribute"in a&&a.removeAttribute(goog.UID_PROPERTY_);try{delete a[goog.UID_PROPERTY_]}catch(b){}};goog.UID_PROPERTY_="closure_uid_"+Math.floor(Math.random()*2147483648).toString(36);goog.uidCounter_=0;goog.getHashCode=goog.getUid;goog.removeHashCode=goog.removeUid;
goog.cloneObject=function(a){var b=goog.typeOf(a);if(b=="object"||b=="array"){if(a.clone)return a.clone();var b=b=="array"?[]:{},c;for(c in a)b[c]=goog.cloneObject(a[c]);return b}return a};goog.bindNative_=function(a,b,c){return a.call.apply(a.bind,arguments)};
goog.bindJs_=function(a,b,c){if(!a)throw Error();if(arguments.length>2){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c)}}else return function(){return a.apply(b,arguments)}};goog.bind=function(a,b,c){goog.bind=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?goog.bindNative_:goog.bindJs_;return goog.bind.apply(null,arguments)};
goog.partial=function(a,b){var c=Array.prototype.slice.call(arguments,1);return function(){var b=Array.prototype.slice.call(arguments);b.unshift.apply(b,c);return a.apply(this,b)}};goog.mixin=function(a,b){for(var c in b)a[c]=b[c]};goog.now=Date.now||function(){return+new Date};
goog.globalEval=function(a){if(goog.global.execScript)goog.global.execScript(a,"JavaScript");else if(goog.global.eval){if(goog.evalWorksForGlobals_==null)goog.global.eval("var _et_ = 1;"),typeof goog.global._et_!="undefined"?(delete goog.global._et_,goog.evalWorksForGlobals_=!0):goog.evalWorksForGlobals_=!1;if(goog.evalWorksForGlobals_)goog.global.eval(a);else{var b=goog.global.document,c=b.createElement("script");c.type="text/javascript";c.defer=!1;c.appendChild(b.createTextNode(a));b.body.appendChild(c);
b.body.removeChild(c)}}else throw Error("goog.globalEval not available");};goog.evalWorksForGlobals_=null;goog.getCssName=function(a,b){var c=function(a){return goog.cssNameMapping_[a]||a},d;d=goog.cssNameMapping_?goog.cssNameMappingStyle_=="BY_WHOLE"?c:function(a){for(var a=a.split("-"),b=[],d=0;d<a.length;d++)b.push(c(a[d]));return b.join("-")}:function(a){return a};return b?a+"-"+d(b):d(a)};goog.setCssNameMapping=function(a,b){goog.cssNameMapping_=a;goog.cssNameMappingStyle_=b};
goog.getMsg=function(a,b){var c=b||{},d;for(d in c)var e=(""+c[d]).replace(/\$/g,"$$$$"),a=a.replace(RegExp("\\{\\$"+d+"\\}","gi"),e);return a};goog.exportSymbol=function(a,b,c){goog.exportPath_(a,b,c)};goog.exportProperty=function(a,b,c){a[b]=c};goog.inherits=function(a,b){function c(){}c.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new c;a.prototype.constructor=a};
goog.base=function(a,b,c){var d=arguments.callee.caller;if(d.superClass_)return d.superClass_.constructor.apply(a,Array.prototype.slice.call(arguments,1));for(var e=Array.prototype.slice.call(arguments,2),f=!1,g=a.constructor;g;g=g.superClass_&&g.superClass_.constructor)if(g.prototype[b]===d)f=!0;else if(f)return g.prototype[b].apply(a,e);if(a[b]===d)return a.constructor.prototype[b].apply(a,e);else throw Error("goog.base called from a method of one name to a method of a different name");};
goog.scope=function(a){a.call(goog.global)};var Zlib={};Zlib.Adler32=function(a){return Zlib.Adler32.update(1,a)};Zlib.Adler32.update=function(a,b){for(var c=a&65535,d=a>>>16&65535,e=0,f=b.length;e<f;e++)c=(c+b[e])%65521,d=(d+c)%65521;return d<<16|c};Zlib.BitStream=function(){this.bitindex=this.index=0;this.buffer=[]};Zlib.BitStream.prototype.writeBits=function(a,b,c){var d,e,f=this.buffer;for(d=0;d<b;d++)if(f[this.index]===void 0&&(f[this.index]=0),c?(e=a&1,a>>>=1):e=(a>>>b-d-1&1)===0?0:1,f[this.index]=f[this.index]<<1|e,this.bitindex++,this.bitindex===8)this.bitindex=0,this.reverseByte(this.index),this.index++};
Zlib.BitStream.prototype.finish=function(){this.bitindex>0&&(this.buffer[this.index]<<=8-this.bitindex);this.reverseByte(this.index);return this.buffer};Zlib.BitStream.prototype.reverseByte=function(a){var b=0,c=this.buffer[a],d;for(d=0;d<8;d++)b=b<<1|c&1,c>>>=1;this.buffer[a]=b;return this.buffer[a]};Zlib.Util={};Zlib.Util.convertNetworkByteOrder=function(a,b){var c=[],d;do d=a&255,c.unshift(d),a>>>=8;while(a>0);if(typeof b==="number")for(;c.length<b;)c.unshift(0);return c};Zlib.Util.slice=function(a,b,c){var d,e=a.length;if(a instanceof Array)return a.slice(b,b+c);d=[];for(var f=0;f<c;f++){if(b+f>=e)break;d.push(a[b+f])}return d};
Zlib.Util.concat=function(a,b){var c=a.length,d=b.length,e;if(a instanceof Array&&b instanceof Array){if(b.length>65535)for(e=0;e<d;e+=65535)Array.prototype.push.apply(a,b.slice(e,e+65535));else Array.prototype.push.apply(a,b);return a}for(e=0;e<d;e++)a[c+e]=b[e];return a};Zlib.Heap=function(a){this.buffer=Array(a*2);this.length=0};Zlib.Heap.prototype.getParent=function(a){return((a-2)/4|0)*2};Zlib.Heap.prototype.getChild=function(a){return 2*a+2};Zlib.Heap.prototype.push=function(a,b){var c,d,e=this.buffer,f;c=this.length;e[this.length++]=b;for(e[this.length++]=a;c>0;)if(d=this.getParent(c),e[c+1]<e[d+1])f=e[c],e[c]=e[d],e[d]=f,f=e[c+1],e[c+1]=e[d+1],e[d+1]=f,c=d;else break;return this.length};
Zlib.Heap.prototype.pop=function(){var a,b,c=this.buffer,d,e,f;b=c[0];a=c[1];this.length-=2;c[0]=c[this.length];c[1]=c[this.length+1];for(f=0;;){e=this.getChild(f);if(e>=this.length)break;e+2<this.length&&c[e+3]<c[e+1]&&(e+=2);if(c[f+1]>c[e+1])d=c[f],c[f]=c[e],c[e]=d,d=c[f+1],c[f+1]=c[e+1],c[e+1]=d;else break;f=e}return{index:a,value:b,length:this.length}};Zlib.RawDeflate=function(a){this.compressionType=a;this.matchTable={};this.freqsLitLen=[];this.freqsDist=[]};Zlib.RawDeflate.Lz77MinLength=3;Zlib.RawDeflate.Lz77MaxLength=258;Zlib.RawDeflate.WindowSize=32768;Zlib.RawDeflate.MaxCodeLength=16;Zlib.RawDeflate.HUFMAX=286;
Zlib.RawDeflate.FixedHuffmanTable=function(){var a=[],b;for(b=0;b<288;b++)switch(!0){case b<=143:a.push([b-0+48,8]);break;case b<=255:a.push([b-144+400,9]);break;case b<=279:a.push([b-256+0,7]);break;case b<=287:a.push([b-280+192,8]);break;default:throw"invalid literal: "+b;}return a}();
Zlib.RawDeflate.prototype.dynamicHuffman=function(a,b,c,d){var e,f,g,i,h;d instanceof Zlib.BitStream||(d=new Zlib.BitStream);g=b[0];b=b[1];i=c[0];h=c[1];for(c=0,e=a.length;c<e;c++)if(f=a[c],d.writeBits(g[f],b[f],!0),f>256)d.writeBits(a[++c],a[++c],!0),d.writeBits(i[a[++c]],h[a[c]],!0),d.writeBits(a[++c],a[++c],!0);else if(f===256)break;return d};
Zlib.RawDeflate.prototype.fixedHuffman=function(a,b){var c,d,e;b instanceof Zlib.BitStream||(b=new Zlib.BitStream);for(c=0,d=a.length;c<d;c++)if(e=a[c],Zlib.BitStream.prototype.writeBits.apply(b,Zlib.RawDeflate.FixedHuffmanTable[e]),e>256)b.writeBits(a[++c],a[++c],!0),b.writeBits(a[++c],5),b.writeBits(a[++c],a[++c],!0);else if(e===256)break;return b.finish()};function Lz77Match(a,b){this.length=a;this.backwordDistance=b}
Lz77Match.prototype.getLengthCode_=function(a){switch(!0){case a===3:a=[257,a-3,0];break;case a===4:a=[258,a-4,0];break;case a===5:a=[259,a-5,0];break;case a===6:a=[260,a-6,0];break;case a===7:a=[261,a-7,0];break;case a===8:a=[262,a-8,0];break;case a===9:a=[263,a-9,0];break;case a===10:a=[264,a-10,0];break;case a<=12:a=[265,a-11,1];break;case a<=14:a=[266,a-13,1];break;case a<=16:a=[267,a-15,1];break;case a<=18:a=[268,a-17,1];break;case a<=22:a=[269,a-19,2];break;case a<=26:a=[270,a-23,2];break;case a<=
30:a=[271,a-27,2];break;case a<=34:a=[272,a-31,2];break;case a<=42:a=[273,a-35,3];break;case a<=50:a=[274,a-43,3];break;case a<=58:a=[275,a-51,3];break;case a<=66:a=[276,a-59,3];break;case a<=82:a=[277,a-67,4];break;case a<=98:a=[278,a-83,4];break;case a<=114:a=[279,a-99,4];break;case a<=130:a=[280,a-115,4];break;case a<=162:a=[281,a-131,5];break;case a<=194:a=[282,a-163,5];break;case a<=226:a=[283,a-195,5];break;case a<=257:a=[284,a-227,5];break;case a===258:a=[285,a-258,0];break;default:throw"invalid length: "+
a;}return a};
Lz77Match.prototype.getDistanceCode_=function(a){switch(!0){case a===1:a=[0,a-1,0];break;case a===2:a=[1,a-2,0];break;case a===3:a=[2,a-3,0];break;case a===4:a=[3,a-4,0];break;case a<=6:a=[4,a-5,1];break;case a<=8:a=[5,a-7,1];break;case a<=12:a=[6,a-9,2];break;case a<=16:a=[7,a-13,2];break;case a<=24:a=[8,a-17,3];break;case a<=32:a=[9,a-25,3];break;case a<=48:a=[10,a-33,4];break;case a<=64:a=[11,a-49,4];break;case a<=96:a=[12,a-65,5];break;case a<=128:a=[13,a-97,5];break;case a<=192:a=[14,a-129,6];
break;case a<=256:a=[15,a-193,6];break;case a<=384:a=[16,a-257,7];break;case a<=512:a=[17,a-385,7];break;case a<=768:a=[18,a-513,8];break;case a<=1024:a=[19,a-769,8];break;case a<=1536:a=[20,a-1025,9];break;case a<=2048:a=[21,a-1537,9];break;case a<=3072:a=[22,a-2049,10];break;case a<=4096:a=[23,a-3073,10];break;case a<=6144:a=[24,a-4097,11];break;case a<=8192:a=[25,a-6145,11];break;case a<=12288:a=[26,a-8193,12];break;case a<=16384:a=[27,a-12289,12];break;case a<=24576:a=[28,a-16385,13];break;case a<=
32768:a=[29,a-24577,13];break;default:throw"invalid distance";}return a};Lz77Match.prototype.toLz77Array=function(){var a=this.backwordDistance,b=[];(0,Zlib.Util.concat)(b,this.getLengthCode_(this.length));(0,Zlib.Util.concat)(b,this.getDistanceCode_(a));return b};
Zlib.RawDeflate.prototype.lz77=function(a){var b,c,d,e,f,g,i=this.matchTable,h,j,k=[];h=0;var n,p=[],o=[];if(n=this.compressionType===Zlib.Deflate.CompressionType.DYNAMIC){for(d=0;d<=285;d++)p[d]=0;for(d=0;d<=29;d++)o[d]=0;p[256]=1}c=a.length;for(b=0;b<c;b++){g=(0,Zlib.Util.slice)(a,b,Zlib.RawDeflate.Lz77MinLength);if(g.length<Zlib.RawDeflate.Lz77MinLength&&h===0){(0,Zlib.Util.concat)(k,g);if(n)for(d=0,e=g.length;d<e;d++)p[g[d]]++;break}f=0;for(d=0,e=g.length;d<e;d++)f=f<<8|g[d]&255;i[f]===void 0&&
(i[f]=[]);if(h>0)h--;else{d=i[f];g=d.length;for(e=0;e<g;e++)if(j=d[e],b-j>Zlib.RawDeflate.WindowSize)d.shift(),e--,g--;else break;d.length>0?(h=this.searchLongestMatch_(a,b,d),d=h.toLz77Array(),(0,Zlib.Util.concat)(k,d),n&&(p[d[0]]++,o[d[3]]++),h=h.length-1):(n&&p[a[b]]++,k.push(a[b]))}i[f].push(b)}if(n)p[256]++,this.freqsLitLen=p,this.freqsDist=o;k.push(256);return k};
Zlib.RawDeflate.prototype.searchLongestMatch_=function(a,b,c){var d,e,f,g,i,h,j=Zlib.RawDeflate.Lz77MinLength,k,n;f=Zlib.RawDeflate.Lz77MaxLength;d=c;c=[];for(e=j;e<f;e+=8){h=d.length;for(i=0;i<h;i++){g=d[i];n=!0;for(k=7;k>=0;k--)if(a[d[i]+e+k]!==a[b+e+k]){n=!1;break}n&&c.push(g)}if(c.length===0)break;d=c;c=[]}e>j&&e--;c=[];for(k=0;k<8&&e<f;k++){h=d.length;for(i=0;i<h;i++)a[d[i]+e]===a[b+e]&&c.push(d[i]);if(c.length===0)break;e++;d=c;c=[]}return new Lz77Match(e,b-Math.max.apply(this,d))};
Zlib.RawDeflate.prototype.getTreeSymbols_=function(a,b,c,d){var e=Array(a+c),f,g,i=Array(316),h=Array(19);for(f=g=0;f<a;f++)e[g++]=b[f];for(f=0;f<c;f++)e[g++]=d[f];for(f=0,b=h.length;f<b;f++)h[f]=0;c=0;for(f=0,b=e.length;f<b;f+=g){for(g=1;f+g<b&&e[f+g]===e[f];g++);a=g;if(e[f]===0)if(a<3)for(;a-- >0;)i[c++]=0,h[0]++;else for(;a>0;)d=a<138?a:138,d>a-3&&d<a&&(d=a-3),d<=10?(i[c++]=17,i[c++]=d-3,h[17]++):(i[c++]=18,i[c++]=d-11,h[18]++),a-=d;else if(i[c++]=e[f],h[e[f]]++,a--,a<3)for(;a-- >0;)i[c++]=e[f],
h[e[f]]++;else for(;a>0;)d=a<6?a:6,d>a-3&&d<a&&(d=a-3),i[c++]=16,i[c++]=d-3,h[16]++,a-=d}return{codes:i.slice(0,c),freqs:h}};
Zlib.RawDeflate.prototype.getLengths_=function(a,b){var c=a.length,d,e=2*Zlib.RawDeflate.HUFMAX-1,f=new Zlib.Heap(2*Zlib.RawDeflate.HUFMAX),g=Array(e),i=Array(e),h,j;d=[];j=4294967295;var k;for(h=0;h<c;h++)a[h]===0?d.push(h):(j>a[h]&&(j=a[h]),k+=a[h]);for(h=0;c-d.length<2;h++)a[d.shift()]=1;if((b|0)>0){if(b!==7&&b!==15)throw"invalid limit number";h=b===15?2584:55;d=c-d.length;d=h-d;j=(0-j*h+d-1)/d|0;for(h=0;h<c;h++)a[h]!==0&&(a[h]+=j)}for(h=0;h<e;h++)g[h]=0,i[h]=0;for(h=0;h<c;h++)a[h]>0&&f.push(h,
a[h]);for(h=Zlib.RawDeflate.HUFMAX;f.length>2;h++)e=f.pop(),j=f.pop(),g[e.index]=h,g[j.index]=h,f.push(h,e.value+j.value);for(;h>=0;h--)g[h]>0&&(i[h]=1+i[g[h]]);return i.slice(0,c)};
Zlib.RawDeflate.prototype.getCodesFromLengths_=function(a){var b=Array(a.length),c=[],d=[],e=0,f,g,i;for(f=0,g=a.length;f<g;f++)c[a[f]]=(c[a[f]]|0)+1;for(f=1,g=Zlib.RawDeflate.MaxCodeLength;f<=g;f++){d[f]=e;e+=c[f]|0;if(e>1<<f)throw"overcommitted";e<<=1}if(e<1<<Zlib.RawDeflate.MaxCodeLength)throw"undercommitted";for(f=0,g=a.length;f<g;f++){e=d[a[f]];d[a[f]]+=1;b[f]=0;for(c=0,i=a[f];c<i;c++)b[f]=b[f]<<1|e&1,e>>>=1}return b};Zlib.Deflate=function(a,b){this.buffer=a;this.compressionType=Zlib.Deflate.CompressionType.DYNAMIC;if(typeof b==="object"&&typeof b.compressionType==="number")this.compressionType=b.compressionType;this.rawDeflate=new Zlib.RawDeflate(this.compressionType)};Zlib.Deflate.CompressionType={NONE:0,FIXED:1,DYNAMIC:2,RESERVED:3};Zlib.Deflate.compress=function(a,b){return(new Zlib.Deflate(a,b)).compress()};
Zlib.Deflate.prototype.compress=function(){var a,b,c,d,e;b=Zlib.CompressionMethod.DEFLATE;switch(b){case Zlib.CompressionMethod.DEFLATE:a=Math.LOG2E*Math.log(Zlib.RawDeflate.WindowSize)-8;break;default:throw"invalid compression method";}a=a<<4|b;switch(b){case Zlib.CompressionMethod.DEFLATE:switch(this.compressionType){case Zlib.Deflate.CompressionType.NONE:b=0;break;case Zlib.Deflate.CompressionType.FIXED:b=1;break;case Zlib.Deflate.CompressionType.DYNAMIC:b=2;break;default:throw"unsupported compression type";
}break;default:throw"invalid compression method";}b=b<<6|0;b|=31-(a*256+b)%31;d=(0,Zlib.Util.convertNetworkByteOrder)(Zlib.Adler32(this.buffer),4);c=this.makeBlocks();e=[];e.push(a,b);(0,Zlib.Util.concat)(e,c);(0,Zlib.Util.concat)(e,d);return e};
Zlib.Deflate.prototype.makeBlocks=function(){var a=[],b,c,d;if(typeof this.buffer==="string")this.buffer=this.buffer.split("").map(function(a){return a.charCodeAt(0)});switch(this.compressionType){case Zlib.Deflate.CompressionType.NONE:for(c=0,d=this.buffer.length;c<d;)b=(0,Zlib.Util.slice)(this.buffer,c,65535),c+=b.length,(0,Zlib.Util.concat)(a,this.makeNocompressBlock(b,c===d));break;case Zlib.Deflate.CompressionType.FIXED:(0,Zlib.Util.concat)(a,this.makeFixedHuffmanBlock(this.buffer,!0));break;
case Zlib.Deflate.CompressionType.DYNAMIC:(0,Zlib.Util.concat)(a,this.makeDynamicHuffmanBlock(this.buffer,!0));break;default:throw"invalid compression type";}return a};Zlib.Deflate.prototype.makeNocompressBlock=function(a,b){var c=[],d,e;c.push((b?1:0)|Zlib.Deflate.CompressionType.NONE<<1);d=a.length;e=~d+65536&65535;c.push(d&255,d>>>8&255,e&255,e>>>8&255);Array.prototype.unshift.apply(a,c);return a};
Zlib.Deflate.prototype.makeFixedHuffmanBlock=function(a,b){var c=new Zlib.BitStream,d,e;d=Zlib.Deflate.CompressionType.FIXED;c.writeBits(b?1:0,1,!0);c.writeBits(d,2,!0);e=this.rawDeflate;d=e.lz77(a);return d=e.fixedHuffman(d,c)};
Zlib.Deflate.prototype.makeDynamicHuffmanBlock=function(a,b){var c=new Zlib.BitStream,d,e,f,g,i,h=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],j,k,n,p,o,q,r=Array(19),l;d=Zlib.Deflate.CompressionType.DYNAMIC;c.writeBits(b?1:0,1,!0);c.writeBits(d,2,!0);e=this.rawDeflate;d=e.lz77(a);j=e.getLengths_(e.freqsLitLen);k=e.getCodesFromLengths_(j);n=e.getLengths_(e.freqsDist);p=e.getCodesFromLengths_(n);for(f=286;f>257&&j[f-1]===0;f--);for(g=30;g>1&&n[g-1]===0;g--);o=e.getTreeSymbols_(f,j,g,n);q=e.getLengths_(o.freqs,
7);for(l=0;l<19;l++)r[l]=q[h[l]];for(i=19;i>4&&r[i-1]===0;i--);h=e.getLengths_(o.freqs);q=e.getCodesFromLengths_(h);c.writeBits(f-257,5,!0);c.writeBits(g-1,5,!0);c.writeBits(i-4,4,!0);for(l=0;l<i;l++)c.writeBits(r[l],3,!0);for(l=0,r=o.codes.length;l<r;l++)if(f=o.codes[l],c.writeBits(q[f],h[f],!0),f>=16){l++;switch(f){case 16:f=2;break;case 17:f=3;break;case 18:f=7;break;default:throw"invalid code: "+f;}c.writeBits(o.codes[l],f,!0)}e.dynamicHuffman(d,[k,j],[p,n],c);return c.finish()};
Zlib.Deflate.NO_EXPORT=!0;Zlib.Deflate.NO_EXPORT||(goog.exportSymbol("Zlib.Deflate",Zlib.Deflate),goog.exportSymbol("Zlib.Deflate.CompressionType",Zlib.Deflate.CompressionType),goog.exportSymbol("Zlib.Deflate.compress",Zlib.Deflate.compress));Zlib.CompressionMethod={DEFLATE:8,RESERVED:15};var CanvasTool={PngEncoder:function(a,b){var c,d,e;this.data=[];if(a instanceof Element)d=a.width,e=a.height,c=a.getContext("2d"),this.data=c.getImageData(0,0,d,e).data;else if(typeof a.length==="number"){if(typeof b!=="object")throw Error("need opt_param object");if(typeof b.width!=="number")throw Error("width property not found");if(typeof b.height!=="number")throw Error("height property not found");d=b.width;e=b.height;this.data=a}else throw Error("invalid arguments");this.setParameters(d,e,b)}};
CanvasTool.PngEncoder.prototype.setParameters=function(a,b,c){var d;typeof c!=="object"&&(c={});this.width=a;this.height=b;this.bitDepth=8;this.colourType=CanvasTool.PngEncoder.ColourType.TRUECOLOR_WITH_ALPHA;this.compressionMethod=CanvasTool.PngEncoder.CompressionMethod.DEFLATE;this.filterMethod=CanvasTool.PngEncoder.FilterMethod.BASIC;this.filterType=CanvasTool.PngEncoder.BasicFilterType.NONE;this.interlaceMethod=CanvasTool.PngEncoder.InterlaceMethod.NONE;this.iccp=this.sbit=this.srgb=this.splt=
this.chrm=this.gamma=null;this.hist=!1;this.ztxt=this.text=this.time=this.phys=null;this.trns=!0;for(d in c)this[d]=c[d];this.palette_=null;this.colourHistogram_=[];this.paletteHistogram_=[];this.validate_()};
CanvasTool.PngEncoder.ChunkType={IHDR:bytearray_("IHDR"),PLTE:bytearray_("PLTE"),IDAT:bytearray_("IDAT"),IEND:bytearray_("IEND"),TRNS:bytearray_("tRNS"),GAMA:bytearray_("gAMA"),CHRM:bytearray_("cHRM"),SBIT:bytearray_("sBIT"),SRGB:bytearray_("sRGB"),ICCP:bytearray_("iCCP"),BKGD:bytearray_("bKGD"),HIST:bytearray_("hIST"),PHYS:bytearray_("pHYs"),SPLT:bytearray_("sPLT"),TEXT:bytearray_("tEXt"),ZTXT:bytearray_("zTXt"),ITXT:bytearray_("iTXt"),TIME:bytearray_("tIME")};
CanvasTool.PngEncoder.CompressionFlag={UNCOMPRESSED:0,COMPRESSED:1};CanvasTool.PngEncoder.CompressionMethod={DEFLATE:0};CanvasTool.PngEncoder.ColourType={GRAYSCALE:0,TRUECOLOR:2,INDEXED_COLOR:3,GRAYSCALE_WITH_ALPHA:4,TRUECOLOR_WITH_ALPHA:6};CanvasTool.PngEncoder.FilterMethod={BASIC:0};CanvasTool.PngEncoder.BasicFilterType={NONE:0,SUB:1,UP:2,AVERAGE:3,PAETH:4};CanvasTool.PngEncoder.InterlaceMethod={NONE:0,ADAM7:1};CanvasTool.PngEncoder.RenderingIntent={PERCEPTUAL:0,RELATIVE:1,SATURATION:2,ABSOLUTE:3};
CanvasTool.PngEncoder.UnitSpecifier={UNKNOWN:0,METRE:1};CanvasTool.PngEncoder.Signature=[137,80,78,71,13,10,26,10];CanvasTool.PngEncoder.RedWeight_=0.29891;CanvasTool.PngEncoder.GreenWeight_=0.58661;CanvasTool.PngEncoder.BlueWeight_=0.11448;
CanvasTool.PngEncoder.Crc32Table_=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,
853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,
4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,
225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,
2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,
2932959818,3654703836,1088359270,936918E3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];
CanvasTool.PngEncoder.Adam7Table_=[{xStart:0,yStart:0,xStep:8,yStep:8},{xStart:4,yStart:0,xStep:8,yStep:8},{xStart:0,yStart:4,xStep:4,yStep:8},{xStart:2,yStart:0,xStep:4,yStep:4},{xStart:0,yStart:2,xStep:2,yStep:4},{xStart:1,yStart:0,xStep:2,yStep:2},{xStart:0,yStart:1,xStep:1,yStep:2}];CanvasTool.PngEncoder.prototype.convert=function(){return str_(this.makePng_())};CanvasTool.PngEncoder.prototype.getPalette=function(){return this.palette_ instanceof Array?this.palette_:this.makeImageArray(this.data).PLTE.map(function(a){return a.split("").map(function(a){return a.charCodeAt(0)})})};
CanvasTool.PngEncoder.prototype.validate_=function(){var a,b,c,d=!1;switch(this.colourType){case CanvasTool.PngEncoder.ColourType.GRAYSCALE:a=[1,2,4,8,16];break;case CanvasTool.PngEncoder.ColourType.INDEXED_COLOR:a=[1,2,4,8];break;case CanvasTool.PngEncoder.ColourType.TRUECOLOR:case CanvasTool.PngEncoder.ColourType.GRAYSCALE_WITH_ALPHA:case CanvasTool.PngEncoder.ColourType.TRUECOLOR_WITH_ALPHA:a=[8,16];break;default:throw Error("invalid colour type");}for(b=0,c=a.length;b<c;b++)if(this.bitDepth===
a[b]){d=!0;break}if(d===!1)throw Error("invalid parameter");};
CanvasTool.PngEncoder.prototype.makePng_=function(){var a=[],b;b=this.makeImageArray(this.data);push_(a,CanvasTool.PngEncoder.Signature);push_(a,this.makeIHDR_());typeof this.chrm==="object"&&this.chrm!==null&&push_(a,this.makecHRM_(this.chrm));typeof this.gamma==="number"&&push_(a,this.makegAMA_(this.gamma));typeof this.iccp==="object"&&this.iccp!==null&&push_(a,this.makeiCCP_(this.iccp));this.sbit instanceof Array&&push_(a,this.makesBIT_(this.sbit));typeof this.srgb==="number"&&push_(a,this.makesRGB_(this.srgb));
switch(this.colourType){case CanvasTool.PngEncoder.ColourType.INDEXED_COLOR:push_(a,this.makePLTE_(b.PLTE));this.palette_=b.PLTE;this.bkgd instanceof Array&&push_(a,this.makebKGD_(this.bkgd,this.palette_));this.hist&&push_(a,this.makehIST_(this.paletteHistogram_));this.trns&&push_(a,this.maketRNS_(b.tRNS));break;case CanvasTool.PngEncoder.ColourType.GRAYSCALE:case CanvasTool.PngEncoder.ColourType.TRUECOLOR:case CanvasTool.PngEncoder.ColourType.GRAYSCALE_WITH_ALPHA:case CanvasTool.PngEncoder.ColourType.TRUECOLOR_WITH_ALPHA:break;
default:throw Error("unknown colour type");}typeof this.phys==="object"&&this.phys!==null&&push_(a,this.makepHYs_(this.phys));typeof this.splt==="object"&&this.splt!==null&&push_(a,this.makesPLT_(this.splt,this.colourHistogram_));this.time instanceof Date&&push_(a,this.maketIME_(this.time));typeof this.text==="object"&&this.text!==null&&push_(a,this.maketEXt_(this.text));typeof this.ztxt==="object"&&this.ztxt!==null&&push_(a,this.makezTXt_(this.ztxt));typeof this.itxt==="object"&&this.itxt!==null&&
push_(a,this.makeiTXt_(this.itxt));push_(a,this.makeIDAT_(b.IDAT));push_(a,this.makeIEND_());return a};
CanvasTool.PngEncoder.prototype.makeIHDR_=function(){var a=[];push_(a,this.networkByteOrder_(this.width,4));push_(a,this.networkByteOrder_(this.height,4));push_(a,this.networkByteOrder_(this.bitDepth,1));push_(a,this.networkByteOrder_(this.colourType,1));push_(a,this.networkByteOrder_(this.compressionMethod,1));push_(a,this.networkByteOrder_(this.filterMethod,1));push_(a,this.networkByteOrder_(this.interlaceMethod,1));return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.IHDR,a)};
CanvasTool.PngEncoder.prototype.makeImageArray=function(a){var b=[],c=this.trns,d=this.bitDepth,e=[],f=[],g={},i={},h=[],j=0,k=0,n=0,p=0,o={},q=0,r=0,l,m,s;for(m=0,s=a.length;m<s;m+=4){l=c?this.rgba2str_(this.slice_(a,m,4)):this.rgb2str_(this.slice_(a,m,3));g[l]=(g[l]|0)+1;j=a[m];k=a[m+1];n=a[m+2];p=a[m+3];q=((j<<8|k)<<8|n)<<8|p;if(o[q]===void 0)r=this.colourHistogram_.length,this.colourHistogram_.push({red:j,green:k,blue:n,alpha:p,count:0}),o[q]=r;this.colourHistogram_[o[q]].count++}j=(this.colourType&
4)>0;switch(this.colourType){case CanvasTool.PngEncoder.ColourType.GRAYSCALE_WITH_ALPHA:case CanvasTool.PngEncoder.ColourType.GRAYSCALE:for(m=0,s=a.length;m<s;m+=4)l=this.rgb2y_.apply(this,this.slice_(a,m,3)),p=a[m+3],d<8&&(l>>>=8-d,p>>>=8-d),l=[l],j&&l.push(p),b.push(l);break;case CanvasTool.PngEncoder.ColourType.TRUECOLOR:case CanvasTool.PngEncoder.ColourType.TRUECOLOR_WITH_ALPHA:for(m=0,s=a.length;m<s;m+=4)c=this.slice_(a,m,j?4:3),b.push(c);break;case CanvasTool.PngEncoder.ColourType.INDEXED_COLOR:for(l in g)h.push(l);
c&&h.sort(function(a,b){return a.charCodeAt(3)<b.charCodeAt(3)?-1:a.charCodeAt(3)>b.charCodeAt(3)?1:a.charCodeAt(0)<b.charCodeAt(0)?-1:a.charCodeAt(0)>b.charCodeAt(0)?1:a.charCodeAt(1)<b.charCodeAt(1)?-1:a.charCodeAt(1)>b.charCodeAt(1)?1:a.charCodeAt(2)<b.charCodeAt(2)?-1:a.charCodeAt(2)>b.charCodeAt(2)?1:0});for(m=0,s=h.length;m<s;m++)l=h[m],c?(l.charCodeAt(3)!==255&&(f[m]=l.charCodeAt(3)),i[l]=m):i[l.slice(0,3)]=m,e.push(l.charCodeAt(0)),e.push(l.charCodeAt(1)),e.push(l.charCodeAt(2));if(this.bkgd instanceof
Array){if(this.bkgd.length!==3)throw Error("wrong background-color length");if(!(this.rgb2str_(this.bkgd)in g)){if(e.length/3===1<<this.bitDepth)throw Error("can not add background-color to palette");e.push(this.bkgd[0]);e.push(this.bkgd[1]);e.push(this.bkgd[2])}}if(e.length/3>1<<this.bitDepth)throw Error("over "+(1<<this.bitDepth)+" colors");for(m=0,s=e.length/3;m<s;m++)this.paletteHistogram_[m]=0;for(m=0,s=a.length;m<s;m+=4)l=c?this.rgba2str_(this.slice_(a,m,4)):this.rgb2str_(this.slice_(a,m,3)),
this.paletteHistogram_[i[l]]++,b.push([i[l]]);break;default:throw Error("invalid colour type");}return{PLTE:e,tRNS:f,IDAT:b}};
CanvasTool.PngEncoder.prototype.makecHRM_=function(a){var b=[];push_(b,this.networkByteOrder_(a.whitePointX*1E4|0,4));push_(b,this.networkByteOrder_(a.whitePointY*1E4|0,4));push_(b,this.networkByteOrder_(a.redX*1E4|0,4));push_(b,this.networkByteOrder_(a.redY*1E4|0,4));push_(b,this.networkByteOrder_(a.greenX*1E4|0,4));push_(b,this.networkByteOrder_(a.greenY*1E4|0,4));push_(b,this.networkByteOrder_(a.blueX*1E4|0,4));push_(b,this.networkByteOrder_(a.blueY*1E4|0,4));return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.CHRM,
b)};CanvasTool.PngEncoder.prototype.makegAMA_=function(a){return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.GAMA,this.networkByteOrder_(1E5/a+0.5|0,4))};
CanvasTool.PngEncoder.prototype.makesBIT_=function(a){var b=[];switch(this.colourType){case CanvasTool.PngEncoder.ColourType.GRAYSCALE:if(a.length!==1)throw Error("wrong sBIT length");push_(b,a.slice(0,1));break;case CanvasTool.PngEncoder.ColourType.TRUECOLOR:if(a.length!==3)throw Error("wrong sBIT length");push_(b,a.slice(0,3));break;case CanvasTool.PngEncoder.ColourType.INDEXED_COLOR:if(a.length!==3)throw Error("wrong sBIT length");push_(b,a.slice(0,3));break;case CanvasTool.PngEncoder.ColourType.GRAYSCALE_WITH_ALPHA:if(a.length!==
2)throw Error("wrong sBIT length");push_(b,a.slice(0,2));break;case CanvasTool.PngEncoder.ColourType.TRUECOLOR_WITH_ALPHA:if(a.length!==4)throw Error("wrong sBIT length");push_(b,a.slice(0,4));break;default:throw Error("unknown colour type");}return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.SBIT,b)};CanvasTool.PngEncoder.prototype.makesRGB_=function(a){return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.SRGB,[a])};
CanvasTool.PngEncoder.prototype.makeiCCP_=function(a){var b=[],c,d,e;c=bytearray_(a.name);e=c.length;if(e>79)throw Error("ICCP Profile name is over 79 characters");for(d=0;d<e;d++)if(!isLatin1Printable_(c[d]))throw Error("wrong iccp profile name.");push_(b,c);b.push(0);b.push(a.compressionMethod);switch(a.compressionMethod){case CanvasTool.PngEncoder.CompressionMethod.DEFLATE:push_(b,Zlib.Deflate.compress(a.profile));break;default:throw Error("unknown ICC Profile compression method");}return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.ICCP,
b)};
CanvasTool.PngEncoder.prototype.makebKGD_=function(a,b){var c=[],d=null,e,f;switch(this.colourType){case CanvasTool.PngEncoder.ColourType.GRAYSCALE:case CanvasTool.PngEncoder.ColourType.GRAYSCALE_WITH_ALPHA:if(a.length!==1)throw Error("wrong background-color length");push_(c,this.networkByteOrder_(a[0],2));break;case CanvasTool.PngEncoder.ColourType.TRUECOLOR:case CanvasTool.PngEncoder.ColourType.TRUECOLOR_WITH_ALPHA:if(a.length!==3)throw Error("wrong background-color length");push_(c,this.networkByteOrder_(a[0],2));
push_(c,this.networkByteOrder_(a[1],2));push_(c,this.networkByteOrder_(a[2],2));break;case CanvasTool.PngEncoder.ColourType.INDEXED_COLOR:if(a.length!==3)throw Error("wrong background-color length");for(e=0,f=b.length;e<f;e+=3)b[e+0]===a[0]&&b[e+1]===a[1]&&b[e+2]===a[2]&&(d=e/3);if(d===null)return[];c.push(d);break;default:throw Error("unknown colour type");}return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.BKGD,c)};
CanvasTool.PngEncoder.prototype.makehIST_=function(a){for(var b=[],c=max_(a),d=0,e=0,f=a.length;e<f;e++)d=a[e],d=d===0?0:d/c*65534+1.5|0,push_(b,this.networkByteOrder_(d,2));return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.HIST,b)};
CanvasTool.PngEncoder.prototype.makesPLT_=function(a,b){var c=[],d,e=0,f=0,g=a.num<0?b.length:a.num,i=0;if(g===0)return[];push_(c,bytearray_(a.name));c.push(0);switch(this.bitDepth){case 16:c.push(16);break;case 8:case 4:case 2:case 1:c.push(8);break;default:throw Error("invalid bit depth");}d=b.sort(function(a,b){return a.count<b.count?1:a.count>b.count?-1:0});for(e=d[0].count;f<g;f++){b=d[f];switch(this.bitDepth){case 16:push_(c,this.networkByteOrder_(b.red<<8|b.red,2));push_(c,this.networkByteOrder_(b.green<<
8|b.green,2));push_(c,this.networkByteOrder_(b.blue<<8|b.blue,2));push_(c,this.networkByteOrder_(b.alpha<<8|b.alpha,2));break;case 8:case 4:case 2:case 1:c.push(b.red);c.push(b.green);c.push(b.blue);c.push(b.alpha);break;default:throw Error("invalid bit depth");}i=b.count/e*65535+0.5|0;push_(c,this.networkByteOrder_(i,2))}return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.SPLT,c)};
CanvasTool.PngEncoder.prototype.makePLTE_=function(a){if(a.length>256)throw Error("over 256 colors");return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.PLTE,a)};CanvasTool.PngEncoder.prototype.makepHYs_=function(a){var b=[];push_(b,this.networkByteOrder_(a.x,4));push_(b,this.networkByteOrder_(a.y,4));b.push(a.unit);return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.PHYS,b)};
CanvasTool.PngEncoder.prototype.maketEXt_=function(a){var b=[];push_(b,bytearray_(a.keyword));b.push(0);push_(b,bytearray_(a.text));return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.TEXT,b)};
CanvasTool.PngEncoder.prototype.makezTXt_=function(a){var b=[];push_(b,bytearray_(a.keyword));b.push(0);b.push(a.compressionMethod);switch(a.compressionMethod){case CanvasTool.PngEncoder.CompressionMethod.DEFLATE:push_(b,Zlib.Deflate.compress(bytearray_(a.text)));break;default:throw Error("unknown compression method");}return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.ZTXT,b)};
CanvasTool.PngEncoder.prototype.makeiTXt_=function(a){var b=[],c;push_(b,bytearray_(a.keyword));b.push(0);if(typeof a.compressionMethod==="number")switch(b.push(CanvasTool.PngEncoder.CompressionFlag.COMPRESSED),b.push(a.compressionMethod),a.compressionMethod){case CanvasTool.PngEncoder.CompressionMethod.DEFLATE:c=Zlib.Deflate.compress(bytearray_(utf8_(a.text)));break;default:throw Error("unknown compression method");}else b.push(CanvasTool.PngEncoder.CompressionFlag.UNCOMPRESSED),b.push(0),c=bytearray_(utf8_(a.text));
push_(b,bytearray_(a.lang));b.push(0);typeof a.translatedKeyword==="string"&&push_(b,bytearray_(utf8_(a.translatedKeyword)));b.push(0);push_(b,c);return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.ITXT,b)};
CanvasTool.PngEncoder.prototype.maketIME_=function(a){var b=[];push_(b,this.networkByteOrder_(a.getUTCFullYear(),2));b.push(a.getUTCMonth()+1);b.push(a.getUTCDate());b.push(a.getUTCHours());b.push(a.getUTCMinutes());b.push(a.getUTCSeconds());return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.TIME,b)};
CanvasTool.PngEncoder.prototype.makeIDAT_=function(a){var b=[],c=this.filterMethod,d=this.filterType,e,f,g,i,h,j,k,n;this.interlace_=this.getInterlace_();this.filter_=this.getFilter_();h=this.getBytesPerCompletePixel_();j=this.interlace_(a);for(k=0,n=j.length;k<n;k++)if(g=j[k],a=g.pixelArray,a.length!==0){e=g.width;this.prevLine_=null;for(f=0,g=g.height;f<g;f++){i=this.slice_(a,f*e,e);i=this.pixelArrayToByteArray_(i);switch(c){case CanvasTool.PngEncoder.FilterMethod.BASIC:b.push(d);push_(b,this.filter_(i,
h));break;default:throw Error("unknown filter method");}this.prevLine_=i}}switch(this.compressionMethod){case CanvasTool.PngEncoder.CompressionMethod.DEFLATE:b=Zlib.Deflate.compress(b);break;default:throw Error("unknown compression method");}return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.IDAT,b)};CanvasTool.PngEncoder.prototype.makeIEND_=function(){return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.IEND,[])};
CanvasTool.PngEncoder.prototype.maketRNS_=function(a){var b=[];switch(this.colourType){case CanvasTool.PngEncoder.ColourType.GRAYSCALE:push_(b,this.networkByteOrder_(a[0],2));break;case CanvasTool.PngEncoder.ColourType.TRUECOLOR:push_(b,this.networkByteOrder_(a[0],2));push_(b,this.networkByteOrder_(a[1],2));push_(b,this.networkByteOrder_(a[2],2));break;case CanvasTool.PngEncoder.ColourType.INDEXED_COLOR:b=a;break;default:throw Error("invalid colour type");}return this.makeChunk_(CanvasTool.PngEncoder.ChunkType.TRNS,
b)};
CanvasTool.PngEncoder.prototype.getBytesPerCompletePixel_=function(){var a,b=(this.colourType&4)>0;switch(this.colourType){case CanvasTool.PngEncoder.ColourType.INDEXED_COLOR:a=1;break;case CanvasTool.PngEncoder.ColourType.GRAYSCALE:case CanvasTool.PngEncoder.ColourType.GRAYSCALE_WITH_ALPHA:a=1;b&&(a+=1);this.bitDepth===16&&(a*=2);break;case CanvasTool.PngEncoder.ColourType.TRUECOLOR:case CanvasTool.PngEncoder.ColourType.TRUECOLOR_WITH_ALPHA:a=3;b&&(a+=1);this.bitDepth===16&&(a*=2);break;default:throw Error("unknown colour type");}return a};
CanvasTool.PngEncoder.prototype.getInterlace_=function(){var a;switch(this.interlaceMethod){case CanvasTool.PngEncoder.InterlaceMethod.NONE:a=this.interlaceNone_;break;case CanvasTool.PngEncoder.InterlaceMethod.ADAM7:a=this.interlaceAdam7_;break;default:throw Error("unknown interlace method");}return a};CanvasTool.PngEncoder.Pass_=function(a,b,c){this.width=a;this.height=b;this.pixelArray=c};
CanvasTool.PngEncoder.prototype.interlaceNone_=function(a){return[new CanvasTool.PngEncoder.Pass_(this.width,this.height,a)]};
CanvasTool.PngEncoder.prototype.interlaceAdam7_=function(a){var b=this.height,c=a.length/b,d,e,f,g,i,h,j,k,n,p=CanvasTool.PngEncoder.Adam7Table_,o,q,r;q=[new CanvasTool.PngEncoder.Pass_(0,0,[]),new CanvasTool.PngEncoder.Pass_(0,0,[]),new CanvasTool.PngEncoder.Pass_(0,0,[]),new CanvasTool.PngEncoder.Pass_(0,0,[]),new CanvasTool.PngEncoder.Pass_(0,0,[]),new CanvasTool.PngEncoder.Pass_(0,0,[]),new CanvasTool.PngEncoder.Pass_(0,0,[])];for(k=0,n=p.length;k<n;k++){r=q[k];o=p[k];for(e=i=h=0;e<b;e+=8)for(g=
o.yStart;g<8;g+=o.yStep)for(d=0;d<c;d+=8)for(f=o.xStart;f<8;f+=o.xStep)if(j=a[d+f+(e+g)*c])i=(d+f-o.xStart)/o.xStep,h=(e+g-o.yStart)/o.yStep,r.pixelArray.push(j);r.width=i+1;r.height=h+1}return q};CanvasTool.PngEncoder.prototype.pixelArrayToByteArray_=function(a){var b=[],c,d,e,f,g,i,h=this.bitDepth,j,k;j=8/h;for(e=0,f=a.length;e<f;e++)if(c=a[e],h<8)e%j===0&&(k=e/j,b[k]=0),b[k]|=c[0]<<(j-e%j-1)*h;else for(g=0,i=c.length;g<i;g++)d=c[g],b.push(d),h===16&&b.push(d);return b};
CanvasTool.PngEncoder.prototype.getFilter_=function(){var a;switch(this.filterMethod){case CanvasTool.PngEncoder.FilterMethod.BASIC:switch(this.filterType){case CanvasTool.PngEncoder.BasicFilterType.NONE:a=this.filterNone_;break;case CanvasTool.PngEncoder.BasicFilterType.SUB:a=this.filterSub_;break;case CanvasTool.PngEncoder.BasicFilterType.UP:a=this.filterUp_;break;case CanvasTool.PngEncoder.BasicFilterType.AVERAGE:a=this.filterAverage_;break;case CanvasTool.PngEncoder.BasicFilterType.PAETH:a=this.filterPaeth_;
break;default:throw Error("unknown filter type");}break;default:throw Error("unknown filter method");}return a};CanvasTool.PngEncoder.prototype.filterNone_=function(a){var b=a;return a};CanvasTool.PngEncoder.prototype.filterSub_=function(a,b){var c=[],d=0,e,f;for(e=0,f=a.length;e<f;e++)d=a[e-b]||0,c.push(a[e]-d+256&255);return c};CanvasTool.PngEncoder.prototype.filterUp_=function(a){var b=[],c,d=this.prevLine_,e,f;for(e=0,f=a.length;e<f;e++)c=d&&d[e]?d[e]:0,b.push(a[e]-c+256&255);return b};
CanvasTool.PngEncoder.prototype.filterAverage_=function(a,b){var c=[],d,e,f=this.prevLine_,g,i;for(g=0,i=a.length;g<i;g++)d=a[g-b]||0,e=f&&f[g]||0,d=d+e>>>1,c.push(a[g]+256-d&255);return c};CanvasTool.PngEncoder.prototype.filterPaeth_=function(a,b){var c=[],d,e,f,g=this.prevLine_,i,h;for(i=0,h=a.length;i<h;i++)d=a[i-b]||0,e=g&&g[i]||0,f=g&&g[i-b]||0,d=this.paethPredictor_(d,e,f),c.push(a[i]-d+256&255);return c};
CanvasTool.PngEncoder.prototype.paethPredictor_=function(a,b,c){var d,e,f;d=a+b-c;e=Math.abs(d-a);f=Math.abs(d-b);d=Math.abs(d-c);return e<=f&&e<=d?a:f<=d?b:c};CanvasTool.PngEncoder.prototype.slice_=function(a,b,c){var d,e=a.length;if(a instanceof Array)return a.slice(b,b+c);d=[];for(var f=0;f<c;f++){if(b+f>=e)break;d.push(a[b+f])}return d};
CanvasTool.PngEncoder.prototype.makeChunk_=function(a,b){var c=[];push_(c,this.networkByteOrder_(b.length,4));push_(c,a);push_(c,b);unshift_(b,a);push_(c,this.networkByteOrder_(this.getCRC32_(b),4));return c};CanvasTool.PngEncoder.prototype.networkByteOrder_=function(a,b){var c=[],d;do d=a&255,c.unshift(d),a>>>=8;while(a>0);if(typeof b==="number")for(;c.length<b;)c.unshift(0);return c};
CanvasTool.PngEncoder.prototype.updateCRC32_=function(a,b){for(var c=0,d=0,e=a.length;d<e;d++)c=(b^a[d])&255,b=b>>>8^CanvasTool.PngEncoder.Crc32Table_[c];return b};CanvasTool.PngEncoder.prototype.getCRC32_=function(a){return this.updateCRC32_(a,4294967295)^4294967295};CanvasTool.PngEncoder.prototype.rgb2y_=function(a,b,c){a=a*CanvasTool.PngEncoder.RedWeight_+b*CanvasTool.PngEncoder.GreenWeight_+c*CanvasTool.PngEncoder.BlueWeight_+1.0E-4;return(a>255?255:a)|0};
CanvasTool.PngEncoder.prototype.rgb2str_=function(a){return a.slice(0,3).map(this.fromCharCode_).join("")};CanvasTool.PngEncoder.prototype.rgba2str_=function(a){return a.map(this.fromCharCode_).join("")};CanvasTool.PngEncoder.prototype.fromCharCode_=function(a){return String.fromCharCode(a).charAt(0)};function push_(a,b){for(var c=0,d=b.length;c<d;c++)a.push(b[c]);return a}function unshift_(a,b){for(var c=0,d=b.length;c<d;c++)a.unshift(b[d-c-1]);return a}
function bytearray_(a){var a=a.split(""),b=[],c,d;for(c=0,d=a.length;c<d;c++)b[c]=a[c].charCodeAt(0);return b}function max_(a){for(var b=0,c=0,d=a.length;c<d;c++)b=b<a[c]||c===0?a[c]:b;return b}function str_(a){for(var b=[],c=0,d=a.length;c<d;c++)b[c]=String.fromCharCode(a[c]);return b.join("")}function isLatin1Printable_(a){return!(a<32||a>126&&a<161||a>255)}function utf8_(a){return unescape(encodeURIComponent(a))}CanvasTool.PngEncoder.NO_EXPORT=!1;
CanvasTool.PngEncoder.NO_EXPORT||(goog.exportSymbol("CanvasTool.PngEncoder",CanvasTool.PngEncoder),goog.exportSymbol("CanvasTool.PngEncoder.ChunkType",CanvasTool.PngEncoder.ChunkType),goog.exportSymbol("CanvasTool.PngEncoder.CompressionMethod",CanvasTool.PngEncoder.CompressionMethod),goog.exportSymbol("CanvasTool.PngEncoder.ColourType",CanvasTool.PngEncoder.ColourType),goog.exportSymbol("CanvasTool.PngEncoder.FilterMethod",CanvasTool.PngEncoder.FilterMethod),goog.exportSymbol("CanvasTool.PngEncoder.BasicFilterType",
CanvasTool.PngEncoder.BasicFilterType),goog.exportSymbol("CanvasTool.PngEncoder.InterlaceMethod",CanvasTool.PngEncoder.InterlaceMethod),goog.exportSymbol("CanvasTool.PngEncoder.RenderingIntent",CanvasTool.PngEncoder.RenderingIntent),goog.exportSymbol("CanvasTool.PngEncoder.UnitSpecifier",CanvasTool.PngEncoder.UnitSpecifier),goog.exportProperty(CanvasTool.PngEncoder.prototype,"convert",CanvasTool.PngEncoder.prototype.convert));})();
