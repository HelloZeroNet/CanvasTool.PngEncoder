<!DOCTYPE html>
<html>
<head>
<title>Zlib Test</title>
<script src="../vendor/google-closure-library/closure/goog/base.js"></script>
<script src="../vendor/png.js/zlib.js"></script>
<script src="../src/deps.js"></script>
<script>
goog.require('goog.testing.jsunit');
goog.require('Zlib');
goog.require('Zlib.Deflate');
</script>
</head>
<body>
<script>
var LOOP = 1000000;

function setUp() {
}

function tearDown() {
}
function testDeflateNoneRandom() {
	random(Zlib.Deflate.CompressionType.NONE);
}

function testDeflateNoneIncrease() {
	increase(Zlib.Deflate.CompressionType.NONE);
}

function testDeflateFixedRandom() {
	random(Zlib.Deflate.CompressionType.FIXED);
}

function testDeflateFixedIncrease() {
	increase(Zlib.Deflate.CompressionType.FIXED);
}

function testDeflateDynamicRandom() {
	random(Zlib.Deflate.CompressionType.DYNAMIC);
}

function testDeflateDynamicIncrease() {
	increase(Zlib.Deflate.CompressionType.DYNAMIC);
}

function random(compressionType) {
	var testData = [];
	var deflate;
	var inflateUint8Array;
	var inflate = [];

	// make random data
	for (var i = 0; i < LOOP; i++) {
		testData[i] = Math.floor(Math.random() * 256);
	}
	G_testRunner.log("Source Size: " + testData.length);

	// deflate
	deflate = Zlib.Deflate.compress(testData, {
		compressionType: compressionType
	});
	G_testRunner.log("Deflate Size: " + deflate.length);

	// inflate
	inflateUint8Array = (new FlateStream(deflate)).getBytes();
	G_testRunner.log("Inflate Size: " + inflateUint8Array.length);

	// uint8array -> array
	for (var i = 0, l = inflateUint8Array.length; i < l; i++) {
		inflate[i] = inflateUint8Array[i];
	}

	assertArrayEquals("deflate -> inflate random", testData, inflate);
}

function increase(compressionType) {
	var testData = [];
	var deflate;
	var inflateUint8Array;
	var inflate = [];

	// make data
	for (var i = 0; i < LOOP; i++) {
		testData[i] = i & 0xff;
	}
	G_testRunner.log("Source Size: " + testData.length);

	// deflate
	deflate = Zlib.Deflate.compress(testData, {
		compressionType: compressionType
	});
	G_testRunner.log("Deflate Size: " + deflate.length);

	// inflate
	inflateUint8Array = (new FlateStream(deflate)).getBytes();
	G_testRunner.log("Inflate Size: " + inflateUint8Array.length);

	// uint8array -> array
	for (var i = 0, l = inflateUint8Array.length; i < l; i++) {
		inflate[i] = inflateUint8Array[i];
	}

	assertArrayEquals("deflate -> inflate increase", testData, inflate);
}

function testHeap() {
	var heapCount = 1000;
	var heap = new Zlib.Heap(heapCount);
	var tmp;

	testData = [];
	for (var i = 0; i < heapCount; i++) {
		tmp = Math.floor(Math.random() * 256);
		testData.push([i, tmp]);
		heap.push(i, tmp);
	}
	testData.sort(function(a, b) { return a[1] - b[1]; });

	for (i = 0; heap.length > 0; i++) {
		tmp = heap.pop();
		assertEquals("data check: " + i, tmp.value, testData[i][1]);
	}
}

function testHuffmanTreeCodeLength() {
	testData = [154, 112, 48, 10, 74, 81, 163, 23, 145, 73, 69, 105, 99, 94, 114, 117, 128, 209, 43, 224, 231, 5, 111, 37, 32, 158, 142, 75, 3, 141, 108, 31, 242, 87, 252, 22, 23, 153, 126, 30, 63, 150, 11, 179, 195, 62, 193, 170, 120, 144, 126, 32, 79, 218, 150, 212, 182, 236, 176, 167, 197, 116, 241, 51, 54, 9, 13, 64, 167, 139, 64, 135, 68, 234, 216, 221, 183, 98, 27, 148, 252, 149, 39, 8, 86, 222, 209, 60, 55, 253, 162, 120, 21, 139, 170, 182, 105, 125, 151, 156, 145, 251, 97, 224, 22, 239, 119, 102, 10, 66, 73, 173, 184, 207, 152, 51, 89, 69, 125, 1, 235, 36, 234, 45, 97, 1, 28, 222, 34, 130, 110, 203, 98, 211, 180, 142, 229, 198, 50, 157, 230, 85, 182, 126, 180, 123, 35, 97, 230, 236, 209, 180, 245, 114, 89, 61, 159, 242, 65, 208, 250, 54, 120, 157, 158, 25, 31, 99, 76, 22, 95, 121, 186, 148, 235, 83, 190, 56, 45, 184, 148, 89, 81, 155, 226, 111, 128, 0, 226, 170, 56, 215, 24, 236, 17, 96, 102, 135, 116, 60, 54, 146, 61, 78, 12, 169, 108, 38, 227, 225, 20, 121, 198, 18, 193, 183, 86, 217, 147, 194, 222, 162, 176, 223, 183, 48, 149, 106, 37, 234, 59, 28, 138, 20, 20, 55, 80, 84, 21, 237, 97, 27, 159, 170, 21, 97, 131, 124, 110, 88, 216, 41, 215, 73, 251, 223];

	var rawdeflate = new Zlib.RawDeflate();

	assertArrayEquals(
		"Freqs to Code Length",
		Zlib.RawDeflate.prototype.getLengths_(testData),
		[8, 8, 9, 12, 9, 9, 8, 10, 8, 9, 9, 8, 8, 8, 8, 8, 8, 7, 10, 7, 7, 13, 8, 10, 10, 8, 8, 9, 14, 8, 8, 10, 7, 9, 7, 11, 10, 8, 8, 10, 9, 8, 12, 8, 7, 9, 7, 8, 8, 8, 8, 10, 9, 7, 8, 7, 8, 7, 8, 8, 7, 8, 7, 9, 9, 12, 11, 9, 8, 8, 9, 8, 9, 7, 7, 7, 7, 8, 10, 8, 7, 8, 10, 12, 9, 7, 7, 9, 9, 7, 8, 8, 11, 8, 8, 8, 8, 8, 8, 8, 8, 7, 8, 7, 11, 7, 8, 8, 12, 9, 9, 8, 7, 7, 8, 9, 9, 9, 8, 15, 7, 10, 7, 9, 8, 15, 10, 7, 10, 8, 8, 7, 8, 7, 8, 8, 7, 7, 9, 8, 7, 9, 8, 8, 8, 8, 10, 8, 7, 7, 7, 8, 7, 8, 9, 9, 8, 7, 9, 7, 7, 9, 8, 8, 8, 10, 10, 8, 9, 11, 8, 8, 7, 8, 7, 9, 7, 9, 9, 7, 8, 9, 9, 8, 7, 8, 8, 0, 7, 8, 9, 7, 10, 7, 11, 8, 8, 8, 8, 9, 9, 8, 9, 9, 11, 8, 8, 10, 7, 7, 11, 8, 7, 11, 7, 8, 9, 7, 8, 7, 7, 8, 8, 7, 8, 9, 8, 8, 10, 7, 9, 10, 8, 11, 11, 9, 9, 9, 11, 7, 8, 10, 8, 8, 11, 8, 8, 8, 8, 9, 7, 10, 7, 9, 7, 7]
	);
}

function testHuffmanTreeCodes() {
	testData = [154, 112, 48, 10, 74, 81, 163, 23, 145, 73, 69, 105, 99, 94, 114, 117, 128, 209, 43, 224, 231, 5, 111, 37, 32, 158, 142, 75, 3, 141, 108, 31, 242, 87, 252, 22, 23, 153, 126, 30, 63, 150, 11, 179, 195, 62, 193, 170, 120, 144, 126, 32, 79, 218, 150, 212, 182, 236, 176, 167, 197, 116, 241, 51, 54, 9, 13, 64, 167, 139, 64, 135, 68, 234, 216, 221, 183, 98, 27, 148, 252, 149, 39, 8, 86, 222, 209, 60, 55, 253, 162, 120, 21, 139, 170, 182, 105, 125, 151, 156, 145, 251, 97, 224, 22, 239, 119, 102, 10, 66, 73, 173, 184, 207, 152, 51, 89, 69, 125, 1, 235, 36, 234, 45, 97, 1, 28, 222, 34, 130, 110, 203, 98, 211, 180, 142, 229, 198, 50, 157, 230, 85, 182, 126, 180, 123, 35, 97, 230, 236, 209, 180, 245, 114, 89, 61, 159, 242, 65, 208, 250, 54, 120, 157, 158, 25, 31, 99, 76, 22, 95, 121, 186, 148, 235, 83, 190, 56, 45, 184, 148, 89, 81, 155, 226, 111, 128, 0, 226, 170, 56, 215, 24, 236, 17, 96, 102, 135, 116, 60, 54, 146, 61, 78, 12, 169, 108, 38, 227, 225, 20, 121, 198, 18, 193, 183, 86, 217, 147, 194, 222, 162, 176, 223, 183, 48, 149, 106, 37, 234, 59, 28, 138, 20, 20, 55, 80, 84, 21, 237, 97, 27, 159, 170, 21, 97, 131, 124, 110, 88, 216, 41, 215, 73, 251, 223];

	var rawdeflate = new Zlib.RawDeflate();
	var lengths = Zlib.RawDeflate.prototype.getLengths_(testData);
	var codes = Zlib.RawDeflate.prototype.getCodesFromLengths_(lengths);

	assertArrayEquals(
		"CodeLength to Codes",
		codes,
		[62, 190, 7, 1535, 263, 135, 126, 287, 254, 391, 71, 1, 129, 65, 193, 33, 161, 0, 799, 64, 32, 4095, 97, 159, 671, 225, 17, 327, 8191, 145, 81, 415, 96, 199, 16, 127, 927, 209, 49, 95, 455, 177, 3583, 113, 80, 39, 48, 241, 9, 137, 73, 607, 295, 112, 201, 8, 41, 72, 169, 105, 40, 233, 104, 167, 423, 1023, 1151, 103, 25, 153, 359, 89, 231, 24, 88, 56, 120, 217, 351, 57, 4, 185, 863, 3071, 487, 68, 36, 23, 279, 100, 121, 249, 639, 5, 133, 69, 197, 37, 165, 101, 229, 20, 21, 84, 1663, 52, 149, 85, 2047, 151, 407, 213, 116, 12, 53, 87, 343, 215, 181, 16383, 76, 223, 44, 471, 117, 32767, 735, 108, 479, 245, 13, 28, 141, 92, 77, 205, 60, 124, 55, 45, 2, 311, 173, 109, 237, 29, 991, 157, 66, 34, 98, 93, 18, 221, 183, 439, 61, 82, 119, 50, 114, 375, 189, 125, 253, 63, 575, 3, 247, 383, 131, 67, 10, 195, 74, 503, 42, 15, 271, 106, 35, 143, 399, 163, 26, 99, 227, 0, 90, 19, 79, 58, 319, 122, 1407, 147, 83, 211, 51, 335, 207, 179, 463, 47, 895, 115, 243, 831, 6, 70, 1919, 11, 38, 255, 102, 139, 303, 22, 75, 86, 54, 203, 43, 118, 171, 175, 107, 235, 191, 14, 431, 703, 27, 1279, 767, 111, 367, 239, 1791, 78, 155, 447, 91, 219, 511, 59, 187, 123, 251, 495, 46, 959, 110, 31, 30, 94]
	);
}

</script>
</body>
</html>
